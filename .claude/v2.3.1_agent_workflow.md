# v2.3.1 Agent Workflow & Dependencies

## Agent Execution Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     v2.3.1 Completion                            │
│                 (2 Agents in Parallel)                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │
                ┌─────────────┴──────────────┐
                │                            │
                ▼                            ▼
    ┌───────────────────────┐    ┌──────────────────────────┐
    │   Agent 1: Production │    │   Agent 2: Security &    │
    │     Hardening (7h)    │    │  Observability (10h)     │
    └───────────────────────┘    └──────────────────────────┘
                │                            │
                │                            │
        ┌───────┴────────┐          ┌────────┴─────────┐
        │                │          │                  │
        ▼                ▼          ▼                  ▼
    ┌────────┐    ┌─────────┐  ┌──────────┐    ┌────────────┐
    │  Task  │    │  Task   │  │  Task    │    │   Task     │
    │   1    │    │   2     │  │   1      │    │    2       │
    │  (2h)  │    │  (2h)   │  │  (2h)    │    │   (3h)     │
    └────────┘    └─────────┘  └──────────┘    └────────────┘
        │              │            │                 │
        │              │            │                 │
        ▼              ▼            ▼                 ▼
    ┌────────┐    ┌─────────┐  ┌──────────┐    ┌────────────┐
    │  Fix   │    │  Rate   │  │  Route   │    │  Tracing   │
    │  Test  │    │ Limit   │  │ Metrics  │    │  Context   │
    │ Isol.  │    │  (NEW)  │  │  (2h)    │    │   (3h)     │
    └────────┘    └─────────┘  └──────────┘    └────────────┘
        │              │            │                 │
        │              │            │                 │
        ▼              ▼            ▼                 ▼
    ┌────────┐    ┌─────────┐  ┌──────────┐    ┌────────────┐
    │22→34   │    │ +8      │  │ All      │    │  +12       │
    │ tests  │    │ tests   │  │ routes   │    │  tests     │
    │ fixed  │    │ pass    │  │ done     │    │  pass      │
    └────────┘    └─────────┘  └──────────┘    └────────────┘
        │              │            │                 │
        └──────┬───────┘            └────────┬────────┘
               │                             │
               ▼                             ▼
        ┌─────────────┐              ┌──────────────┐
        │   Task 3    │              │   Task 3     │
        │   Quotas    │              │  Tests (2h)  │
        │   (3h)      │              └──────────────┘
        └─────────────┘                      │
               │                             │
               ▼                             ▼
        ┌─────────────┐              ┌──────────────┐
        │  +10 tests  │              │  +39 tests   │
        │   pass      │              │   pass       │
        └─────────────┘              └──────────────┘
               │                             │
               └──────────┬──────────────────┘
                          │
                          ▼
                  ┌───────────────┐
                  │   Task 4      │
                  │   Docs (4h)   │
                  │  (Agent 2)    │
                  └───────────────┘
                          │
                          ▼
                  ┌───────────────┐
                  │  1500 lines   │
                  │  API Guide    │
                  └───────────────┘
                          │
                          │
            ┌─────────────┴──────────────┐
            │                            │
            ▼                            ▼
    ┌────────────────┐          ┌────────────────┐
    │  PR #1 Ready   │          │  PR #2 Ready   │
    │ (Agent 1)      │          │ (Agent 2)      │
    │ 52/52 tests ✓  │          │ 39/39 tests ✓  │
    └────────────────┘          └────────────────┘
            │                            │
            │      ┌────────────────┐    │
            └─────▶│  MERGE ORDER   │◀───┘
                   └────────────────┘
                           │
                    ┌──────┴───────┐
                    │              │
                    ▼              ▼
            ┌──────────────┐  ┌──────────────┐
            │ 1. Agent 2   │  │ 2. Agent 1   │
            │ (simpler)    │  │ (rebase)     │
            └──────────────┘  └──────────────┘
                    │              │
                    └──────┬───────┘
                           │
                           ▼
                  ┌────────────────┐
                  │  v2.3.1 Tagged │
                  │  & Released    │
                  └────────────────┘
```

---

## Agent 1: Production Hardening

### Task Breakdown

```
┌─────────────────────────────────────────────────────────────┐
│                    Agent 1 Timeline (7h)                     │
└─────────────────────────────────────────────────────────────┘

Hour 0-2: Task 1 - Fix Test Isolation
├── Hour 0.0-0.5: Analyze 12 failing tests
│   └── Run: pytest tests/api/test_project_endpoints.py -v
├── Hour 0.5-1.0: Debug database cleanup issues
│   └── Inspect: tests/api/conftest.py fixtures
├── Hour 1.0-1.5: Fix ChromaDB collection persistence
│   └── Modify: conftest.py isolation fixtures
└── Hour 1.5-2.0: Verify all tests pass
    └── Run: pytest tests/api/test_project_endpoints.py -v --count=10
    └── Result: 34/34 tests passing ✓

Hour 2-4: Task 2 - Per-Project Rate Limiting
├── Hour 2.0-2.5: Create rate_limiter.py
│   └── File: knowledgebeast/api/rate_limiter.py (80 lines)
├── Hour 2.5-3.0: Implement composite key function
│   └── Function: get_project_rate_limit_key()
├── Hour 3.0-3.5: Apply to query/ingest endpoints
│   └── File: knowledgebeast/api/routes.py (add @limiter.limit)
└── Hour 3.5-4.0: Write and run tests
    └── File: tests/api/test_rate_limiting.py (8 tests)
    └── Result: 8/8 tests passing ✓

Hour 4-7: Task 3 - Project Resource Quotas
├── Hour 4.0-5.0: Add quota tracking to ProjectManager
│   └── File: knowledgebeast/core/project_manager.py
│   └── Methods: check_quota(), increment_quota_usage()
├── Hour 5.0-6.0: Enforce quotas in API routes
│   └── File: knowledgebeast/api/routes.py
│   └── Add: Quota checks before ingest/query
├── Hour 6.0-6.5: Create quota endpoint
│   └── Endpoint: GET /api/v2/projects/{id}/quota
└── Hour 6.5-7.0: Write and run tests
    └── File: tests/api/test_quotas.py (10 tests)
    └── Result: 10/10 tests passing ✓

Final State:
├── Tests: 52/52 passing (100%)
├── New Code: ~450 lines
├── Files Modified: 5
└── Ready for PR ✓
```

### Dependencies

**Internal Dependencies (within Agent 1)**:
- Task 1 → Task 2: Must fix tests before adding rate limiting (clean baseline)
- Task 2 → Task 3: No dependency (can be parallelized if needed)

**External Dependencies**:
- None - Agent 1 is fully independent

**Files Modified**:
1. `tests/api/conftest.py` (fix isolation)
2. `knowledgebeast/api/rate_limiter.py` (NEW)
3. `knowledgebeast/api/routes.py` (rate limiting + quotas)
4. `knowledgebeast/core/project_manager.py` (quota tracking)
5. `tests/api/test_rate_limiting.py` (NEW)
6. `tests/api/test_quotas.py` (NEW)

---

## Agent 2: Security & Observability

### Task Breakdown

```
┌─────────────────────────────────────────────────────────────┐
│                    Agent 2 Timeline (10h)                    │
└─────────────────────────────────────────────────────────────┘

Hour 0-2: Task 1 - Route Instrumentation
├── Hour 0.0-1.0: Add metric recording to all routes
│   └── File: knowledgebeast/api/routes.py
│   └── Add: record_project_query(), record_project_ingestion()
├── Hour 1.0-1.5: Register ProjectAuthMiddleware
│   └── File: knowledgebeast/api/app.py
│   └── Add: app.add_middleware(ProjectAuthMiddleware)
└── Hour 1.5-2.0: Verify metrics endpoint
    └── Test: curl http://localhost:8000/metrics
    └── Result: All project metrics visible ✓

Hour 2-5: Task 2 - Distributed Tracing Context
├── Hour 2.0-3.0: Enhance observability.py
│   └── File: knowledgebeast/utils/observability.py
│   └── Add: add_project_context(), @trace_project_operation
├── Hour 3.0-4.0: Apply tracing to ProjectManager
│   └── File: knowledgebeast/core/project_manager.py
│   └── Add: @trace_project_operation decorators
├── Hour 4.0-4.5: Add baggage propagation
│   └── File: knowledgebeast/api/routes.py
│   └── Add: set_baggage("project.id", project_id)
└── Hour 4.5-5.0: Write tracing tests
    └── File: tests/observability/test_project_tracing.py (12 tests)
    └── Result: 12/12 tests passing ✓

Hour 5-7: Task 3 - Comprehensive Tests
├── Hour 5.0-6.0: API key tests
│   └── File: tests/api/test_project_api_keys.py (15 tests)
│   └── Test: create, scope enforcement, expiration
├── Hour 6.0-7.0: Metrics tests
│   └── File: tests/observability/test_project_metrics.py (12 tests)
│   └── Test: recording, isolation, accuracy
└── Result: 39/39 tests passing ✓

Hour 7-10: Task 4 - API Documentation
├── Hour 7.0-9.0: Write comprehensive API guide
│   └── File: docs/api/MULTI_PROJECT_GUIDE.md (~1500 lines)
│   └── Sections: Overview, auth, endpoints, examples, troubleshooting
├── Hour 9.0-9.5: Create Python client examples
│   └── File: examples/multi_project_client.py
└── Hour 9.5-10.0: Create cURL examples
    └── File: examples/multi_project_curl.sh
    └── Result: All examples tested and working ✓

Final State:
├── Tests: 39/39 passing (100%)
├── New Code: ~2,800 lines (including docs)
├── Files Modified: 8
└── Ready for PR ✓
```

### Dependencies

**Internal Dependencies (within Agent 2)**:
- Task 1 → Task 2: Tracing depends on metrics infrastructure (soft dependency)
- Task 1,2 → Task 3: Tests depend on implementation complete
- Task 1,2,3 → Task 4: Docs depend on features complete

**External Dependencies**:
- None - Agent 2 is fully independent

**Files Modified**:
1. `knowledgebeast/api/routes.py` (metrics + baggage)
2. `knowledgebeast/api/app.py` (middleware registration)
3. `knowledgebeast/utils/observability.py` (tracing helpers)
4. `knowledgebeast/core/project_manager.py` (tracing decorators)
5. `tests/api/test_project_api_keys.py` (NEW)
6. `tests/observability/test_project_metrics.py` (NEW)
7. `tests/observability/test_project_tracing.py` (NEW)
8. `docs/api/MULTI_PROJECT_GUIDE.md` (NEW)
9. `examples/multi_project_client.py` (NEW)
10. `examples/multi_project_curl.sh` (NEW)

---

## Cross-Agent Dependencies

### Shared Files

**Potential Conflict**: `knowledgebeast/api/routes.py`
- Agent 1 modifies: Rate limiting + quota enforcement
- Agent 2 modifies: Metric recording + baggage propagation

**Resolution Strategy**:
1. Agent 2 merges first (simpler changes)
2. Agent 1 rebases on updated main
3. Manual conflict resolution if needed (likely separate functions)

### No Other Conflicts

All other files are agent-specific:
- Agent 1: rate_limiter.py, project_manager.py (quotas only)
- Agent 2: observability.py, metrics.py, docs, examples

---

## Merge Strategy

### Phase 1: Agent 2 Merge (Simpler)

```bash
# After Agent 2 completes
cd /Users/danielconnolly/Projects/KnowledgeBeast-agent2
git checkout feature/security-observability
git pull origin main  # Ensure up to date
pytest tests/ -v  # Verify all tests pass
git push origin feature/security-observability

# Create PR
gh pr create --title "feat: Security & Observability completion (v2.3.1)" \
             --body "Completes Agent 2 work for v2.3.1"

# Review and merge (squash recommended)
gh pr merge --squash
```

### Phase 2: Agent 1 Merge (After Agent 2)

```bash
# After Agent 2 merged
cd /Users/danielconnolly/Projects/KnowledgeBeast-agent1
git checkout feature/production-hardening
git fetch origin
git rebase origin/main  # Rebase on updated main

# Resolve conflicts in knowledgebeast/api/routes.py if needed
# Conflict will be in routes.py where both agents modified

# After rebase
pytest tests/ -v  # Verify all tests still pass
git push origin feature/production-hardening --force-with-lease

# Create PR
gh pr create --title "feat: Production hardening completion (v2.3.1)" \
             --body "Completes Agent 1 work for v2.3.1"

# Review and merge (squash recommended)
gh pr merge --squash
```

### Phase 3: Tag Release

```bash
cd /Users/danielconnolly/Projects/KnowledgeBeast
git checkout main
git pull origin main

# Tag v2.3.1
git tag -a v2.3.1 -m "KnowledgeBeast v2.3.1 - Complete v2.3.0 Improvements

Features:
- Per-project rate limiting with composite keys
- Project resource quotas (documents, storage, queries)
- Full route instrumentation with project metrics
- Distributed tracing with project context
- Comprehensive test coverage (91 new tests)
- Multi-project API documentation

All 12 improvements from v2.3.0 plan now complete (100%)."

git push origin v2.3.1
```

---

## Success Criteria

### Agent 1 Success
- [ ] 34/34 API tests passing (isolation fixed)
- [ ] 8/8 rate limiting tests passing
- [ ] 10/10 quota tests passing
- [ ] Total: 52/52 tests passing (100%)
- [ ] Rate limiting functional (429 on exceeded)
- [ ] Quotas enforced (402 on exceeded)
- [ ] PR ready for merge

### Agent 2 Success
- [ ] All routes emit project metrics
- [ ] All operations traced with project context
- [ ] 15/15 API key tests passing
- [ ] 12/12 metrics tests passing
- [ ] 12/12 tracing tests passing
- [ ] Total: 39/39 tests passing (100%)
- [ ] API documentation complete (1500+ lines)
- [ ] Examples tested and working
- [ ] PR ready for merge

### Combined Success (v2.3.1)
- [ ] Both PRs merged to main
- [ ] 91/91 new tests passing (100%)
- [ ] 12/12 improvements complete (100%)
- [ ] Grade improved: A- (90) → A (92)
- [ ] Documentation complete
- [ ] v2.3.1 tagged and released

---

## Risk Mitigation

### Risk 1: Merge Conflicts in routes.py
**Probability**: Medium
**Impact**: Low
**Mitigation**:
- Agent 2 merges first (fewer changes)
- Agent 1 rebases carefully
- Manual conflict resolution if needed

### Risk 2: Test Isolation Not Fully Fixed
**Probability**: Low
**Impact**: Medium
**Mitigation**:
- Run tests with --count=10 to verify stability
- Use per-function fixtures for full isolation
- Add cleanup after each test

### Risk 3: Documentation Takes Longer Than 4h
**Probability**: Medium
**Impact**: Low
**Mitigation**:
- Documentation is last task (won't block PRs)
- Can be completed in follow-up commit
- Examples are highest priority

---

## Timeline Summary

```
Day 1-2 (Oct 9-10): Parallel Execution
├── Agent 1: 7 hours (Tasks 1-3)
└── Agent 2: 10 hours (Tasks 1-4)

Day 3 (Oct 11): PR Preparation
├── Agent 1: Test verification, PR creation
└── Agent 2: Test verification, PR creation

Day 4 (Oct 12): Merge & Integration
├── 09:00-10:00: Review Agent 2 PR
├── 10:00-11:00: Merge Agent 2 PR
├── 11:00-12:00: Agent 1 rebase on main
├── 12:00-13:00: Review Agent 1 PR
└── 13:00-14:00: Merge Agent 1 PR

Day 5 (Oct 13): Release
├── 09:00-10:00: Full test suite run
├── 10:00-11:00: Performance benchmarking
├── 11:00-12:00: Create release notes
├── 12:00-13:00: Tag v2.3.1
└── 13:00-14:00: Publish release

Total Wall-Clock Time: ~5 days (with buffer)
Total Development Time: 17 hours (7h + 10h)
Sequential Equivalent: 17 hours (no parallelization benefit due to agent length)
```

---

**Last Updated**: October 9, 2025
**Status**: Ready to Execute
**Confidence**: High (both branches 65% complete, clear work items)
