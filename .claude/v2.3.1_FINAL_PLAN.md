# v2.3.1 Final Plan - Reduced Scope (Option 2)

**Decision**: Option 2 - Reduced Scope for achievable delivery
**Target Release**: October 15-17, 2025 (5-7 days)
**Total Effort**: 20 hours (8h Agent 1 + 12h Agent 2)
**Strategy**: Ship critical fixes + core features, defer nice-to-haves to v2.3.2

---

## Executive Summary

**What's Shipping in v2.3.1**:
- ✅ Fix 24 failing API tests (critical bug fixes)
- ✅ Project-level API key system (complete)
- ✅ Route instrumentation with project metrics
- ✅ 20 essential tests (API keys + metrics)
- ✅ API reference documentation

**Deferred to v2.3.2** (2 weeks later):
- ⏳ Per-project rate limiting
- ⏳ Project resource quotas
- ⏳ Distributed tracing enhancements
- ⏳ Comprehensive documentation with examples

**Grade Impact**:
- Before: A- (90/100)
- After v2.3.1: A- (90/100) - maintains current grade
- After v2.3.2: A (92/100) - achieves original target

---

## Agent 1: Production Hardening (8 hours)

**Branch**: `feature/production-hardening`
**Current State**: 22/46 tests passing (48%)
**Target State**: 46/46 tests passing (100%)

### Tasks

#### Task 1: Fix Test Isolation (2h)
**Status**: Fixtures exist, need minor cleanup

**What to do**:
1. Run failing tests with `--pdb` to identify issues
2. Check database cleanup in `conftest.py`
3. Ensure ChromaDB collections are properly isolated
4. Verify ProjectManager singleton resets

**Success**: All tests can run in any order

---

#### Task 2: Fix API Endpoint Bugs (6h) ⭐ **CRITICAL**
**Status**: 24 tests failing - API endpoints broken

**Failing Categories**:
- GET project (returns wrong data)
- UPDATE project (not persisting)
- DELETE project (not actually deleting)
- QUERY project (not wired to ChromaDB)
- INGEST project (not storing documents)
- Lifecycle tests (cascade failures)

**Diagnostic Approach** (1h):
```bash
# Run single failing test with debugger
pytest tests/api/test_project_endpoints.py::test_get_project_success -v --pdb

# Check what GET returns vs what test expects
# Identify pattern (likely one root cause affecting multiple endpoints)
```

**Common Root Causes**:
1. **ProjectManager not initialized properly** - Check singleton pattern
2. **ChromaDB collections not created** - Check collection initialization
3. **Data format mismatch** - Check Pydantic models vs actual responses
4. **Missing await** - Check async/sync boundaries

**Implementation** (4h):
- Fix identified root cause
- Update all affected endpoints
- Verify data persistence
- Test cascade operations

**Verification** (1h):
```bash
pytest tests/api/test_project_endpoints.py -v --tb=short
# Target: 46/46 passing
```

**Success Criteria**:
- ✅ 46/46 API tests passing (100%)
- ✅ All CRUD operations working
- ✅ Projects persist across requests
- ✅ Multi-project isolation verified

---

### Deferred to v2.3.2

~~Task 3: Per-Project Rate Limiting (2h)~~ → v2.3.2
~~Task 4: Project Resource Quotas (3h)~~ → v2.3.2

---

## Agent 2: Security & Observability (12 hours)

**Branch**: `feature/security-observability`
**Current State**: 40% complete (core systems built, no tests, routes not instrumented)
**Target State**: 80% complete (working features, essential tests, basic docs)

### Tasks

#### Task 1: Complete Route Instrumentation (3h)
**Status**: Metrics defined, routes need updates

**Endpoints to Instrument** (15 total):
```python
# Project Management (5 endpoints)
POST   /api/v2/projects              - record_project_creation()
GET    /api/v2/projects               - record_project_list()
GET    /api/v2/projects/{id}          - record_project_get()
PUT    /api/v2/projects/{id}          - record_project_update()
DELETE /api/v2/projects/{id}          - record_project_delete()

# Document Operations (2 endpoints)
POST   /api/v2/projects/{id}/ingest   - measure_project_query() + record_ingest()
POST   /api/v2/projects/{id}/query    - measure_project_query() + record_cache()

# API Key Management (3 endpoints) - Already added by Agent 2
POST   /api/v2/{project_id}/api-keys          - record_api_key_creation()
GET    /api/v2/{project_id}/api-keys          - record_api_key_list()
DELETE /api/v2/{project_id}/api-keys/{key_id} - record_api_key_revoke()

# Monitoring (2 endpoints) - From v2.3.0
GET    /api/v2/{project_id}/health    - record_health_check()
GET    /api/v2/health                  - record_global_health()

# Export/Import (2 endpoints) - From v2.3.0
POST   /api/v2/{project_id}/export    - record_export()
POST   /api/v2/import                  - record_import()

# Streaming (1 endpoint) - From v2.3.0
POST   /api/v2/{project_id}/query/stream - record_stream_query()
```

**Implementation Pattern**:
```python
from knowledgebeast.utils.metrics import (
    measure_project_query,
    record_project_ingest,
    record_project_error,
)

@router_v2.post("/projects/{project_id}/query")
async def query_project(project_id: str, query: QueryRequest):
    try:
        with measure_project_query(project_id):
            result = await project_manager.query(project_id, query.query)
        return result
    except Exception as e:
        record_project_error(project_id, "query", str(e))
        raise
```

**Time Breakdown**:
- 15 endpoints × 10 min each = 2.5h
- Testing metrics endpoint = 0.5h

**Success Criteria**:
- ✅ All 15 project endpoints emit metrics
- ✅ Metrics visible at `/metrics` endpoint
- ✅ Project ID in all metric labels

---

#### Task 2: Write Essential Tests (6h) ⭐ **FOCUS HERE**
**Status**: 0/39 tests exist, writing 20 most critical

**Test Priorities** (20 tests total):

**Category 1: API Key Tests** (10 tests) - CRITICAL
```python
# tests/api/test_project_api_keys.py

def test_create_api_key():
    """Create project API key"""

def test_create_api_key_with_scopes():
    """Create key with specific scopes"""

def test_list_api_keys():
    """List all keys for project"""

def test_revoke_api_key():
    """Revoke API key"""

def test_api_key_scope_enforcement():
    """Read-only key cannot write"""

def test_api_key_expiration():
    """Expired keys rejected"""

def test_api_key_validation():
    """Valid keys accepted"""

def test_api_key_invalid_format():
    """Invalid format rejected"""

def test_api_key_project_isolation():
    """Key for project A cannot access project B"""

def test_api_key_last_used_tracking():
    """Last used timestamp updated"""
```

**Category 2: Metrics Tests** (8 tests) - HIGH
```python
# tests/observability/test_project_metrics.py

def test_project_query_metrics_recorded():
    """Query metrics appear in /metrics"""

def test_project_ingest_metrics_recorded():
    """Ingest metrics appear in /metrics"""

def test_project_metrics_isolation():
    """Project A metrics separate from Project B"""

def test_project_error_metrics():
    """Errors recorded with project_id"""

def test_project_cache_hit_metrics():
    """Cache hits tracked per project"""

def test_project_cache_miss_metrics():
    """Cache misses tracked per project"""

def test_project_metrics_labels():
    """All metrics have project_id label"""

def test_metrics_endpoint_accessible():
    """/metrics endpoint returns Prometheus format"""
```

**Category 3: Integration Tests** (2 tests) - SANITY CHECK
```python
# tests/api/test_project_security_integration.py

def test_end_to_end_api_key_flow():
    """Create project → Generate key → Use key → Revoke"""

def test_metrics_recorded_during_operations():
    """Query → Check metrics updated"""
```

**Time Breakdown**:
- 10 API key tests × 20 min = 3.3h
- 8 metrics tests × 15 min = 2h
- 2 integration tests × 20 min = 0.7h

**Success Criteria**:
- ✅ 20/20 essential tests passing
- ✅ API key system fully validated
- ✅ Metrics recording verified
- ✅ Project isolation confirmed

---

#### Task 3: Create API Reference Documentation (3h)
**Status**: Not started, creating minimal docs

**Scope**: API reference ONLY (no examples, no troubleshooting)

**Document Structure**:
```markdown
# KnowledgeBeast Multi-Project API Reference

## Authentication
- Global API keys (admin)
- Project API keys (scoped)

## Endpoints

### Project Management
POST   /api/v2/projects
GET    /api/v2/projects
GET    /api/v2/projects/{id}
PUT    /api/v2/projects/{id}
DELETE /api/v2/projects/{id}

### Document Operations
POST /api/v2/projects/{id}/ingest
POST /api/v2/projects/{id}/query

### API Key Management
POST   /api/v2/{project_id}/api-keys
GET    /api/v2/{project_id}/api-keys
DELETE /api/v2/{project_id}/api-keys/{key_id}

### Monitoring
GET /api/v2/{project_id}/health
GET /api/v2/health
GET /metrics

## Request/Response Schemas
[Pydantic model documentation]

## Status Codes
- 200 OK
- 201 Created
- 400 Bad Request
- 401 Unauthorized
- 403 Forbidden
- 404 Not Found
- 500 Internal Server Error
```

**Auto-Generation Approach**:
```python
# Generate from OpenAPI schema
import json
from knowledgebeast.api.app import create_app

app = create_app()
openapi_schema = app.openapi()

# Convert to markdown (use script)
# Saves 2h vs writing manually
```

**Time Breakdown**:
- Generate from OpenAPI: 1h
- Format and organize: 1h
- Add authentication guide: 1h

**Success Criteria**:
- ✅ All project endpoints documented
- ✅ Request/response schemas clear
- ✅ Authentication explained
- ✅ Ready for users to reference

---

### Deferred to v2.3.2

~~Task 4: Distributed Tracing Context (3h)~~ → v2.3.2
~~Task 5: Comprehensive Documentation with Examples (4h)~~ → v2.3.2

---

## Timeline

### Day 1-2 (Oct 9-10): Parallel Execution
- **Agent 1**: Fix isolation (2h) + Start API bug fixes (4h)
- **Agent 2**: Route instrumentation (3h) + Start tests (3h)

### Day 3 (Oct 11): Complete Implementation
- **Agent 1**: Finish API bug fixes (2h)
- **Agent 2**: Finish tests (3h) + Start docs (1h)

### Day 4 (Oct 12): Documentation & Testing
- **Agent 1**: Final verification, PR ready
- **Agent 2**: Finish docs (2h), PR ready

### Day 5 (Oct 13): Merge & Release
- 09:00-10:00: Review Agent 2 PR
- 10:00-11:00: Merge Agent 2 PR
- 11:00-12:00: Agent 1 rebase
- 12:00-13:00: Review Agent 1 PR
- 13:00-14:00: Merge Agent 1 PR

### Day 6 (Oct 14): Validation
- Full test suite run
- Performance check
- Tag v2.3.1

### Day 7 (Oct 15): Release
- Create release notes
- Publish to GitHub
- Update documentation

---

## Success Criteria

### Agent 1 Success
- [x] 46/46 API tests passing (100%)
- [x] All CRUD operations working
- [x] Projects persist correctly
- [x] Multi-project isolation verified
- [x] PR ready for merge

### Agent 2 Success
- [x] 15 endpoints instrumented with metrics
- [x] 20/20 essential tests passing (100%)
- [x] API key system fully validated
- [x] Metrics visible at `/metrics`
- [x] API reference documentation complete
- [x] PR ready for merge

### Combined Success (v2.3.1)
- [x] Both PRs merged to main
- [x] 66 total new/fixed tests passing
- [x] Grade maintained: A- (90/100)
- [x] Core security + observability shipped
- [x] Clear roadmap for v2.3.2
- [x] v2.3.1 tagged and released

---

## v2.3.2 Roadmap (Deferred Features)

**Timeline**: 2 weeks after v2.3.1 (October 25 - November 5)
**Effort**: 12-15 hours

**Features**:
1. Per-project rate limiting (3h)
2. Project resource quotas (3h)
3. Distributed tracing context (4h)
4. Comprehensive documentation (4h)
5. Additional tests (2h)

**Goal**: Achieve A grade (92/100) with all 12 improvements

---

## Risk Mitigation

### Risk 1: API Bug Fixes Take > 6h
**Probability**: Medium
**Mitigation**:
- Start with 1h diagnostic phase
- If > 6h, focus on critical paths only
- Ship partially working (query/ingest priority)

### Risk 2: Test Writing Takes > 6h
**Probability**: Low
**Mitigation**:
- Prioritize API key tests (most critical)
- Can ship with 15 tests if needed
- Defer metrics tests to v2.3.2

### Risk 3: Documentation Takes > 3h
**Probability**: Low
**Mitigation**:
- Auto-generate from OpenAPI
- Focus on API reference only
- Examples can come later

---

## Merge Strategy

### Phase 1: Agent 2 First
```bash
cd /Users/danielconnolly/Projects/KnowledgeBeast/.worktrees/security-observability
git checkout feature/security-observability
pytest tests/ -v  # Verify 20/20 tests pass
gh pr create --title "feat: Security & Observability core (v2.3.1)"
gh pr merge --squash
```

### Phase 2: Agent 1 Second
```bash
cd /Users/danielconnolly/Projects/KnowledgeBeast/.worktrees/production-hardening
git fetch origin
git rebase origin/main
pytest tests/ -v  # Verify 46/46 tests pass
gh pr create --title "feat: Fix API endpoints and test isolation (v2.3.1)"
gh pr merge --squash
```

### Phase 3: Tag Release
```bash
cd /Users/danielconnolly/Projects/KnowledgeBeast
git checkout main
git pull origin main
git tag -a v2.3.1 -m "KnowledgeBeast v2.3.1 - Core Security & Observability

Features:
- Fixed 24 critical API endpoint bugs
- Project-level API key system (complete)
- Route instrumentation with project metrics
- 20 essential tests for validation
- API reference documentation

Deferred to v2.3.2:
- Per-project rate limiting
- Project resource quotas
- Distributed tracing enhancements
- Comprehensive documentation"

git push origin v2.3.1
```

---

## Comparison: v2.3.1 vs v2.3.2

| Feature | v2.3.1 (Now) | v2.3.2 (Later) |
|---------|--------------|----------------|
| API Bug Fixes | ✅ | ✅ |
| API Key System | ✅ | ✅ |
| Route Metrics | ✅ | ✅ |
| Essential Tests | ✅ 20 tests | ✅ 57 tests |
| API Reference | ✅ | ✅ |
| Rate Limiting | ❌ | ✅ |
| Quotas | ❌ | ✅ |
| Tracing Context | ❌ | ✅ |
| Comprehensive Docs | ❌ | ✅ |
| **Grade** | **A- (90/100)** | **A (92/100)** |
| **Timeline** | **5-7 days** | **+2 weeks** |

---

## Files Modified

### Agent 1
1. `tests/api/conftest.py` - Fix isolation (minor tweaks)
2. `knowledgebeast/api/routes.py` - Fix GET/UPDATE/DELETE/QUERY/INGEST
3. `knowledgebeast/core/project_manager.py` - Fix persistence bugs
4. `tests/api/test_project_endpoints.py` - All tests passing

### Agent 2
1. `knowledgebeast/api/routes.py` - Add metrics to 15 endpoints
2. `tests/api/test_project_api_keys.py` - NEW (10 tests)
3. `tests/observability/test_project_metrics.py` - NEW (8 tests)
4. `tests/api/test_project_security_integration.py` - NEW (2 tests)
5. `docs/api/MULTI_PROJECT_API_REFERENCE.md` - NEW (~800 lines)

---

## Expected Outcomes

### Test Coverage
- **Before**: 1,413 tests (78.4% pass rate)
- **After v2.3.1**: 1,433 tests (80%+ pass rate)
- **Improvement**: +20 tests, +1.6% pass rate
- **After v2.3.2**: 1,470 tests (85%+ pass rate)

### Features
- **Before**: 8/12 improvements (67%)
- **After v2.3.1**: 9/12 improvements (75%)
- **After v2.3.2**: 12/12 improvements (100%)

### Grade
- **Before**: A- (90/100)
- **After v2.3.1**: A- (90/100) - maintained
- **After v2.3.2**: A (92/100) - achieved

### Timeline
- **v2.3.1**: October 15-17 (achievable!)
- **v2.3.2**: November 1-5 (realistic)

---

**Last Updated**: October 9, 2025
**Status**: ✅ **APPROVED - READY TO LAUNCH**
**Confidence**: **HIGH**
**Risk**: **LOW** (reduced scope, focused goals)
